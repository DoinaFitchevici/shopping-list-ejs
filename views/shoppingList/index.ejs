<%- include("../partials/head.ejs") %> 
<%- include("../partials/header.ejs") %>

<h1>Your Shopping List</h1>

<% if (successMessages && successMessages.length > 0) { %>
  <div class="alert alert-success">
    <% successMessages.forEach(function (msg) { %>
      <p><%= msg %></p>
    <% }); %>
  </div>
<% } %>

<% if (errorMessages && errorMessages.length > 0) { %>
  <div class="alert alert-danger">
    <% errorMessages.forEach(function (msg) { %>
      <p><%= msg %></p>
    <% }); %>
  </div>
<% } %>

<ul id="shopping-list" class="list-group">
  <% if (shoppingList && shoppingList.products.length > 0) { %>
    <% shoppingList.products.forEach(item => { %>
      <li class="list-group-item <%= item.done ? 'completedTodo' : '' %>">
        <div class="container">
          <div class="column">
            <% if (item.done) { %>
              <strike><%= item.product.name %></strike>
            <% } else { %>
            <a href="/shoppingList/markItemDone/<%= item.product._id %>">Mark as done</a>
              <span><%= item.product.name %></span>
            <% } %>
            <span class="quantity">(<%= item.quantity %>)</span>
          </div>
          <div class="column">
            <form method="POST" action="/shoppingList/delete/<%= item.product._id %>" style="display: inline">
              <button type="submit" class="button">delete</button>
              <input type="hidden" name="_csrf" value="<%= _csrf %>" />
            </form>
          </div>
        </div>
      </li>
    <% }) %>
  <% } else { %>
    <li class="list-group-item">Your shopping list is empty.</li>
  <% } %>
</ul>

<nav aria-label="Page navigation">
  <ul class="pagination">
    <% for(let i = 1; i <= totalPages; i++) { %>
      <li class="page-item <%= page === i ? 'active' : '' %>">
        <a class="page-link" href="?page=<%= i %>"><%= i %></a>
      </li>
    <% } %>
  </ul>
</nav>

<a href="/shoppingList/add" class="button">Add Item to Shopping List</a>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.mark-done-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', async function () {
        const productId = this.dataset.productId;
        const done = this.checked;

        try {
          const response = await fetch(`/shoppingList/mark-done/${productId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'CSRF-Token': '<%= _csrf %>'
            },
            body: JSON.stringify({ done })
          });

          if (!response.ok) {
            console.error('Failed to mark item as done');
          }

          const row = this.closest('li');
          if (done) {
            row.classList.add('completedTodo');
          } else {
            row.classList.remove('completedTodo');
          }
        } catch (error) {
          console.error('Error:', error);
        }
      });
    });
  });
</script>

<%- include("../partials/footer.ejs") %>
